<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>

	<script src="js/jquery-1.11.3.min.js"></script>
</head>
<body>
	<div id="toolbar">
	<button data-name="fontname" data-value="宋体">宋体</button>
	<button data-name="fontsize" data-value="5">大字体</button>
	<button data-name="forecolor" data-value="red">红色字体</button>
	<button data-name="backColor" data-value="lightgreen">浅绿背景</button>
	<button data-name="bold">加粗</button>
	<button data-name="italic">斜体</button>    
	<button data-name="underline">下划线</button>   
		<button data-name="justifyCenter">居中</button>
		<button data-name="justifyLeft">左对齐</button>
		<button data-name="justifyRight">右对齐</button>
		<button data-name="indent">添加缩进</button>
		<button data-name="outdent">去掉缩进</button> 
		<div class="clear"></div>
		<button data-name="fontname" data-value="宋体">宋体</button>
		<button data-name="fontsize" data-value="5">大字体</button>
		<button data-name="forecolor" data-value="red">红色字体</button>
		<button data-name="backColor" data-value="lightgreen">浅绿背景</button>
		<button data-name="bold">加粗</button>
		<button data-name="italic">斜体</button>    
		<button data-name="underline">下划线</button>   

		<button data-name="formatblock" data-value="div">插入div</button>
		<button data-name="inserthorizontalrule">插入hr</button>    
		<button data-name="insertorderedlist">插入ol</button>    
		<button data-name="insertunorderedlist">插入ul</button>
		<button data-name="insertparagraph">插入p</button>    
		<button data-name="insertimage" data-value="http://files.cnblogs.com/files/xiaohuochai/zan.gif">插入图像</button>    
		<button data-name="createlink" data-value="www.cnblogs.com/xiaohuochai">增加链接</button>
		<button data-name="unlink">删除链接</button>    
		<button data-name="inserthorizontalrule">插入hr</button>    
		<button data-name="insertQuote">插入quote</button>    
		<button data-name="insertTable">插入table</button>    

	</div>
	<div class="clear"></div>
	<div id="editor" contenteditable="true" style="min-height: 600px;">
		<p><br></p>		
	</div>

	<script>
		editor.focus()

		// 调整表格
		function adjustList() {
		    let lists = document.querySelectorAll("ol, ul");
		     for (let i = 0; i < lists.length; i++) {
		        let ele = lists[i]; // ol
		        let parentNode = ele.parentNode;
		        if (parentNode.tagName === 'P' && parentNode.lastChild === parentNode.firstChild) {
		                parentNode.insertAdjacentElement('beforebegin', ele);
		                parentNode.remove()
		        }
		        if ($(parentNode).text() == '') {
		        	$(parentNode).remove()
		        }
		    }
		}

		function adjustContainer() {
			var children = $(editor).children()
			if (children.length == 0) {
				$(editor).append('<p><br/></p>')
			}

		}

		function adjustQuote() {
		    let quotes = document.querySelectorAll("blockquote");
		     for (let i = 0; i < quotes.length; i++) {
		        let quote = quotes[i];
		        if ($(quote).text() == '') {
		        	$(quote).remove()
		        }
		    }
		}

		function findParentByTagName(root, name) {
		    let parent = root;
		    if (typeof name === "string") {
		        name = [name];
		    }
		    while (name.indexOf(parent.nodeName.toLowerCase()) === -1 && parent.nodeName !== "BODY" && parent.nodeName !== "HTML") {
		        parent = parent.parentNode;
		    }
		    return parent.nodeName === "BODY" || parent.nodeName === "HTML" ? null : parent;
		}

		function insertLink(url, title) {
		    let selection = document.getSelection(),
		        range = selection.getRangeAt(0);
		    if(range.collapsed) {
		        let start = range.startContainer,
		            parent = findParentByTagName(start, 'a');
		        if(parent) {
		            parent.setAttribute('src', url);
		        }else {
		            this.insertHTML(`<a href="${url}">${title}</a>`);
		        }
		    }else {
		        document.execCommand('createLink', false, url);
		    }
		} 

		function insertP(argument) {
			this.insertHTML('<p><br></p>');
		}

		var btns = document.getElementsByTagName('button');
		for(var i = 0; i < btns.length; i++){
		    btns[i].onclick = function(event){
		    	editor.focus()
		    	var data_value = this.getAttribute('data-value') ? this.getAttribute('data-value') : false;
		    	var data_name  = this.getAttribute('data-name')

		    	if (data_name == 'insertQuote') {
		    		var html = '<blockquote><p><br></p></blockquote>'
		    		document.execCommand('insertHTML', false, html)
		    		// editor.focus()
		    		return
		    	}

		    	if (data_name == 'insertTable') {
		    		var html = '<table border = "1"><tr><th></th><th></th><th></th></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></table>'
		    		document.execCommand('insertHTML', false, html)
		    		
		    		return
		    	}

		    	document.execCommand(data_name, false, data_value)
		        // document.execCommand(this.getAttribute('data-name'));
		        if (this.getAttribute('data-name') == 'insertorderedlist') {
		        	// adjustList()
		        }
		        // editor.focus()
		    }
		}

		function resetRange(startContainer, startOffset, endContainer, endOffset) {
		    let selection = window.getSelection();
		        selection.removeAllRanges();
		    let range = document.createRange();
		    range.setStart(startContainer, startOffset);
		    range.setEnd(endContainer, endOffset);
		    selection.addRange(range);
		}

		function adjustEditor() {
			console.log(editor.childNodes)
			console.log(editor.childNodes.length)
			if ($(editor).text() == '') {
				console.log('here')
				editor.innerHTML = '<p><br></p>'
				console.log(editor.innerHTML)
			}
		}

		// $("blockquote").blur( function() {
		// 	console.log(123)
		// 	adjustQuote()
		// })
		// $('blockquote').blur(funciton() {
		// 	adjustQuote()
		// }) 
		document.onkeydown = function(event) {
			// console.log(event.key)
			
			if (event.key == 'Enter') {
				adjustQuote()
				// adjustList()

				var sel = window.getSelection()
				var range = sel.getRangeAt(0)
				var curNode = range.startContainer
				var parentNode = curNode.parentNode
				
				// console.log(range)
				if (curNode.tagName == 'P' && parentNode.tagName == 'BLOCKQUOTE' && parentNode.lastChild == curNode && range.startOffset == 0) {
					event.preventDefault()
					parentNode.removeChild(curNode)
					$(parentNode).after('<p><br></p>')
					setStartAfterNode(parentNode)
				}


				// if (curNode.tagName == 'LI' && parentNode.tagName == 'OL' && range.startOffset == 0) {
				// 	event.preventDefault()
				// 	parentNode.removeChild(curNode)
				// 	$(parentNode).after('<p><br></p>')
				// 	setStartAfterNode(parentNode)
				// }
			}

			if (event.key == 'Backspace' || event.key == 'Enter') {
				console.log('adjustEditor')
				adjustEditor()
			}
			
		}


		function setStartAfterNode(node) {
			let selection = window.getSelection();
		        selection.removeAllRanges();
			let range = document.createRange();
			range.setStartAfter(node)
			range.setEndAfter(node)
			selection.addRange(range)
		}
		
		$(document).ready(function() {
			$('#editor').bind("DOMSubtreeModified",function(){
			  console.log('change')
			  // if(editor.childNodes.length == 1 && ) 
			});
		}) 


	</script>
	
	
	<script>
		
	</script>
</body>
</html>